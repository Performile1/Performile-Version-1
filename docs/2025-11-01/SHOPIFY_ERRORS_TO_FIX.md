# SHOPIFY PLUGIN ERRORS - TO FIX

**Date:** November 1, 2025  
**Priority:** CRITICAL  
**Status:** üö® BLOCKING CHECKOUT INTEGRATION  
**Estimated Time:** 45-60 minutes

---

## üêõ ERRORS DISCOVERED

### **1. 401 Unauthorized Errors (Multiple)**
```
Failed to load resource: the server responded with a status of 401 ()
URL: performile-teststore...&checkout_type=c1
```

**Frequency:** 4 occurrences  
**Impact:** HIGH - Checkout integration completely broken  
**Likely Cause:**
- Shopify session token not being passed
- Missing or invalid authentication headers
- Expired or incorrect API credentials
- Missing OAuth scopes for checkout access

---

### **2. Cross-Origin Autofocus Block (Multiple)**
```
Blocked autofocusing on a <input> element in a cross-origin subframe.
```

**Frequency:** 4 occurrences  
**Impact:** MEDIUM - Poor UX, but not blocking  
**Likely Cause:**
- Browser security policy blocking focus in iframe
- Shopify checkout running in cross-origin iframe
- Need to use Shopify App Bridge for focus management

**Solution:**
- Remove autofocus attributes from inputs in checkout extension
- Use Shopify App Bridge focus APIs instead
- Or accept this as expected browser behavior

---

### **3. Content Security Policy Violation**
```
Refused to frame 'https://performile-teststore.myshopify.com/' 
because an ancestor violates the following Content Security Policy directive: 
"frame-ancestors 'none'".
```

**Impact:** CRITICAL - Cannot embed Shopify in iframe  
**Likely Cause:**
- Trying to embed Shopify store in iframe
- Shopify CSP blocks all iframe embedding
- Incorrect integration approach

**Solution:**
- Don't try to iframe Shopify pages
- Use Shopify App Bridge for embedded apps
- Use checkout extensions (not iframes) for checkout customization

---

### **4. 404 Not Found**
```
(index):1  Failed to load resource: the server responded with a status of 404 ()
```

**Impact:** MEDIUM - Missing resource  
**Likely Cause:**
- Missing index page or route
- Incorrect URL in checkout extension
- Missing static asset

---

## üîç ROOT CAUSE ANALYSIS

### **Primary Issue: Authentication Flow**

The 401 errors suggest the Shopify session token is not being properly:
1. Generated by Shopify
2. Passed to our checkout extension
3. Validated by our backend

### **Secondary Issue: Integration Approach**

The CSP violation suggests we may be trying to:
- Embed Shopify pages in iframes (not allowed)
- Use wrong integration method for checkout

---

## üìã INVESTIGATION CHECKLIST

### **1. Shopify App Configuration**
- [ ] Check API scopes in `shopify.app.toml`
- [ ] Verify checkout extension is properly configured
- [ ] Check if app is installed correctly in test store
- [ ] Verify OAuth flow is working

**Required Scopes:**
```toml
scopes = "read_orders,write_orders,read_products,read_checkouts,write_checkouts"
```

### **2. Checkout Extension Setup**
- [ ] Review `extensions/checkout-ui/shopify.extension.toml`
- [ ] Check if extension has network access enabled
- [ ] Verify extension is using Shopify App Bridge correctly
- [ ] Check session token handling

**File:** `apps/shopify/performile-delivery/extensions/checkout-ui/shopify.extension.toml`

### **3. Session Token Flow**
- [ ] Check if extension is requesting session token
- [ ] Verify token is being passed to API calls
- [ ] Check token validation in backend
- [ ] Verify token expiration handling

**File:** `apps/shopify/performile-delivery/extensions/checkout-ui/src/Checkout.tsx`

### **4. API Endpoints**
- [ ] Check if API endpoints expect Shopify session token
- [ ] Verify CORS headers allow Shopify domain
- [ ] Check authentication middleware
- [ ] Test API calls with valid token

---

## üîß FILES TO CHECK

### **1. Shopify App Configuration**
```
apps/shopify/performile-delivery/
‚îú‚îÄ‚îÄ shopify.app.toml          # API scopes, app settings
‚îú‚îÄ‚îÄ index.js                  # Main app file, OAuth setup
‚îî‚îÄ‚îÄ package.json              # Dependencies
```

### **2. Checkout Extension**
```
apps/shopify/performile-delivery/extensions/checkout-ui/
‚îú‚îÄ‚îÄ shopify.extension.toml    # Extension config
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Checkout.tsx          # Main extension component
‚îÇ   ‚îî‚îÄ‚îÄ index.tsx             # Entry point
‚îî‚îÄ‚îÄ package.json
```

### **3. Backend API**
```
api/
‚îú‚îÄ‚îÄ shopify/                  # Shopify-specific endpoints
‚îú‚îÄ‚îÄ orders/                   # Order endpoints
‚îî‚îÄ‚îÄ middleware/               # Auth middleware
```

---

## üéØ SOLUTION STEPS

### **Step 1: Verify Shopify App Scopes (5 min)**
```bash
# Check shopify.app.toml
cat apps/shopify/performile-delivery/shopify.app.toml
```

Ensure scopes include:
- `read_checkouts`
- `write_checkouts`
- `read_orders`
- `write_orders`

### **Step 2: Check Extension Configuration (5 min)**
```bash
# Check extension config
cat apps/shopify/performile-delivery/extensions/checkout-ui/shopify.extension.toml
```

Ensure:
- `network_access = true`
- Correct API version
- Proper capabilities enabled

### **Step 3: Review Session Token Handling (15 min)**

**In Checkout Extension:**
```typescript
import { useSessionToken } from '@shopify/ui-extensions-react/checkout';

function Checkout() {
  const { token } = useSessionToken();
  
  // Use token in API calls
  const response = await fetch('/api/endpoint', {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });
}
```

### **Step 4: Test Authentication Flow (10 min)**
1. Open Shopify test store
2. Add item to cart
3. Go to checkout
4. Open browser DevTools ‚Üí Network tab
5. Check for 401 errors
6. Inspect request headers for session token

### **Step 5: Fix CSP Issue (5 min)**
- Remove any iframe embedding attempts
- Use Shopify App Bridge for embedded apps
- Use checkout extensions for checkout customization

### **Step 6: Fix Autofocus Issue (5 min)**
- Remove `autofocus` attributes from inputs
- Or accept as expected browser behavior (low priority)

---

## ‚úÖ SUCCESS CRITERIA

**Must Fix:**
- ‚úÖ No 401 errors in checkout
- ‚úÖ Session token properly passed and validated
- ‚úÖ Checkout extension loads without errors
- ‚úÖ API calls authenticated correctly

**Should Fix:**
- ‚úÖ No CSP violations
- ‚úÖ No 404 errors

**Nice to Fix:**
- ‚ö†Ô∏è Autofocus warnings (low priority, may be unavoidable)

---

## üìä TESTING CHECKLIST

After fixes:
- [ ] Install app in test store
- [ ] Add product to cart
- [ ] Go to checkout
- [ ] Verify extension loads
- [ ] Check Network tab for errors
- [ ] Test courier selection in checkout
- [ ] Verify order creation works
- [ ] Check order data in database

---

## üö® BLOCKERS

**This is blocking:**
- ‚úÖ Shopify plugin completion (stuck at 95%)
- ‚úÖ Checkout flow testing
- ‚úÖ Week 1 Issue #5 (Checkout flow)
- ‚úÖ Beta launch preparation

**Priority:** Fix this FIRST thing tomorrow!

---

## üìö RESOURCES

**Shopify Documentation:**
- [Checkout UI Extensions](https://shopify.dev/docs/api/checkout-ui-extensions)
- [Session Tokens](https://shopify.dev/docs/apps/auth/oauth/session-tokens)
- [App Bridge](https://shopify.dev/docs/api/app-bridge)
- [OAuth Scopes](https://shopify.dev/docs/api/usage/access-scopes)

**Related Files:**
- `apps/shopify/performile-delivery/extensions/checkout-ui/shopify.extension.toml`
- `apps/shopify/performile-delivery/index.js`
- `apps/shopify/performile-delivery/shopify.app.toml`

---

## üí° NOTES

**Common Shopify Auth Issues:**
1. Missing scopes ‚Üí 401 errors
2. Expired session token ‚Üí 401 errors
3. Wrong API version ‚Üí Various errors
4. CORS not configured ‚Üí Network errors
5. Extension not installed ‚Üí 404 errors

**Remember:**
- Shopify checkout extensions run in sandboxed environment
- Session tokens expire after 1 minute
- Must use Shopify App Bridge for embedded apps
- Cannot iframe Shopify pages (CSP blocks it)

---

*Created: November 1, 2025, 12:45 AM*  
*Priority: CRITICAL*  
*Estimated Fix Time: 45-60 minutes*  
*Status: Ready for investigation*
